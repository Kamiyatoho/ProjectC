{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-6" data-aos="fade-down">Tableau de bord du Portefeuille</h1>

{% if data is not defined or not data %}
<p class="text-gray-400">
    Aucune donnée à afficher. Cliquez sur "Synchroniser" pour récupérer les données du portefeuille Binance.
</p>
{% else %}
<!-- Indicateurs principaux -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8" data-aos="fade-up" data-aos-delay="100">
    <div class="bg-gray-800 p-4 rounded" data-aos="zoom-in" data-aos-delay="200">
        <h2 class="text-sm text-gray-400">Valeur actuelle</h2>
        <p class="text-xl font-semibold">{{ data.valeur_actuelle | round(2) }} USDC</p>
    </div>
    <div class="bg-gray-800 p-4 rounded" data-aos="zoom-in" data-aos-delay="200">
        <h2 class="text-sm text-gray-400">Capital investi</h2>
        <p class="text-xl font-semibold">{{ data.capital_investi | round(2) }} USDC</p>
    </div>
    <div class="bg-gray-800 p-4 rounded" data-aos="zoom-in" data-aos-delay="200">
        <h2 class="text-sm text-gray-400">Plus-value réalisée</h2>
        <p class="text-xl font-semibold {% if data.pl_realise >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            {{ data.pl_realise | round(2) }} USDC
        </p>
    </div>
    <div class="bg-gray-800 p-4 rounded" data-aos="zoom-in" data-aos-delay="200">
        <h2 class="text-sm text-gray-400">Plus-value latente</h2>
        <p class="text-xl font-semibold {% if data.pl_latent >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
            {{ data.pl_latent | round(2) }} USDC
        </p>
    </div>
    <div class="bg-gray-800 p-4 rounded" data-aos="zoom-in" data-aos-delay="200">
        <h2 class="text-sm text-gray-400">Solde USDC disponible</h2>
        <p class="text-xl font-semibold">{{ data.solde_usdc | round(2) }} USDC</p>
    </div>
</div>

<!-- PnL toggle
<div class="mb-4">
    <button id="togglePnL" class="bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded">
        Afficher P/L en %
    </button>
</div> -->

<!-- Positions ouvertes -->
<h2 class="text-xl font-semibold mb-3" data-aos="fade-right">Positions Ouvertes</h2>
{% if data.open_positions %}
<div class="overflow-x-auto mb-8" data-aos="fade-up" data-aos-delay="50">
    <table id="open-positions-table" class="min-w-full text-sm">
        <thead class="bg-gray-700 text-gray-300">
        <tr>
            <th class="py-2 px-4 text-left">Actif</th>
            <th class="py-2 px-4 text-right">Quantité</th>
            <th class="py-2 px-4 text-right">Prix moyen</th>
            <th class="py-2 px-4 text-right">Prix actuel</th>
            <th class="py-2 px-4 text-right pl-col-header">P/L latente (USDC)</th>
        </tr>
        </thead>
        <tbody>
        {% for pos in data.open_positions %}
        <tr class="border-b border-gray-800">
            <td class="py-2 px-4">{{ pos.asset }}</td>
            <td class="py-2 px-4 text-right">{{ pos.quantity | round(6) }}</td>
            <td class="py-2 px-4 text-right">{{ pos.avg_price | round(4) }} USDC</td>
            <td class="py-2 px-4 text-right">{{ pos.current_price | round(4) }} USDC</td>
            <td class="py-2 px-4 text-right pl-col"
                data-usd="{{ pos.pl_latent | round(2) }}"
                data-usd-sign="{{ 'positive' if pos.pl_latent >= 0 else 'negative' }}" >
                        <span class="{% if pos.pl_latent >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                            {{ pos.pl_latent | round(2) }}
                        </span>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-gray-400 mb-8">Aucune position ouverte.</p>
{% endif %}

<!-- Positions fermées -->
<h2 class="text-xl font-semibold mb-3" data-aos="fade-right">Positions Fermées</h2>
{% if data.closed_positions %}
<div class="overflow-x-auto mb-4" data-aos="fade-up" data-aos-delay="50">
    <table id="closed-positions-table" class="min-w-full text-sm">
        <thead class="bg-gray-700 text-gray-300">
        <tr>
            <th class="py-2 px-4 text-left">Actif</th>
            <th class="py-2 px-4 text-right">P/L réalisé</th>
        </tr>
        </thead>
        <tbody>
        {% for pos in data.closed_positions %}
        <tr class="border-b border-gray-800">
            <td class="py-2 px-4">{{ pos.asset }}</td>
            <td class="py-2 px-4 text-right {% if pos.pl_realise >= 0 %}text-green-400{% else %}text-red-400{% endif %}">
                {{ pos.pl_realise | round(2) }} USDC
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
<h2 class="text-xl font-semibold mb-3" data-aos="fade-right">Répartition des Positions Ouvertes</h2>
<div class="bg-gray-800 p-4 rounded mb-8" style="max-width:600px; margin:0 auto; height:600px;" data-aos="fade-up" data-aos-delay="50">
    <canvas id="assetPieChart"></canvas>
</div>
{% else %}
<p class="text-gray-400">Aucune position fermée pour le moment.</p>
{% endif %}
{% endif %}

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

<script>
    $(document).ready(function() {
        // Préparation des données
        const chartLabels = [{% for pos in data.open_positions %}"{{ pos.asset }}"{% if not loop.last %}, {% endif %}{% endfor %}];
        const chartData = [{% for pos in data.open_positions %}{{ (pos.quantity * pos.current_price) | round(2) }}{% if not loop.last %}, {% endif %}{% endfor %}];

        // Initialisation du camembert (seulement si l'élément existe)
        const chartCanvas = document.getElementById('assetPieChart');
        if (chartCanvas) {
            const ctx = chartCanvas.getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5CF6']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#ddd' }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = ctx.chart.data.datasets[0].data.reduce((sum, v) => sum + v, 0);
                                return total > 0 ? Math.round(value / total * 100) + '%' : '';
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 12 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Initialisation DataTable avec boutons et recherche alignée
        ['#open-positions-table', '#closed-positions-table'].forEach(function(selector) {
            if (!$.fn.DataTable.isDataTable(selector)) {
                $(selector).DataTable({
                    paging: true,
                    pageLength: 15,
                    lengthMenu: [10, 25, 50, 100],
                    searching: true,
                    info: false,
                    dom: `
                        <'flex justify-between items-center mb-4'
                            <'flex space-x-2'B>
                            <'ml-auto'f>
                        >
                        <'overflow-x-auto't>
                        <'flex justify-between items-center mt-4'ip>
                    `,
                    buttons: [
                        {
                            extend: 'csvHtml5',
                            text: 'Exporter CSV',
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Exporter Excel',
                        }
                    ]
                });
            }
        });
        // Fonction de basculement P/L USDC <-> %
        document.getElementById('togglePnL').addEventListener('click', function() {
            const cells = document.querySelectorAll('.pl-col');
            const header = document.querySelector('.pl-col-header');
            if (this.innerText.includes('%')) {
                // Afficher en USDC
                header.innerText = 'P/L latente (USDC)';
                cells.forEach(cell => {
                    const val = parseFloat(cell.getAttribute('data-usd'));
                    const sign = cell.getAttribute('data-usd-sign') === 'positive' ? 'text-green-400' : 'text-red-400';
                    cell.innerHTML = `<span class="${sign}">${val.toFixed(2)}</span>`;
                });
                this.innerText = 'Afficher P/L en %';
            } else {
                // Afficher en pourcentage
                header.innerText = 'P/L latente (%)';
                cells.forEach(cell => {
                    const usd = parseFloat(cell.getAttribute('data-usd'));
                    const qty = parseFloat(cell.parentElement.children[1].innerText);
                    const avgPrice = parseFloat(cell.parentElement.children[2].innerText);
                    const percent = qty * avgPrice > 0 ? (usd / (qty * avgPrice) * 100) : 0;
                    const sign = percent >= 0 ? 'text-green-400' : 'text-red-400';
                    cell.innerHTML = `<span class="${sign}">${percent.toFixed(2)}</span>`;
                });
                this.innerText = 'Afficher P/L en USDC';
            }
        });
    });
</script>
{% endblock %}